# 局域网任务接收端现状与改造提案

## 1. 接收端现状

### 1.1 接口行为
- 接口路径：`POST /api/transfer/task`（参见 `app/src/main/java/com/example/smartdosing/web/WebServerManager.kt` 中 `route("/transfer")` 段）。
- Ktor 直接将请求体反序列化为 `IncomingTaskRequest`，顶层要求字段：`transferId`、`senderUID`、`senderName`、`senderIP`、`timestamp`、`task`、`recipe`。
- 收到请求后调用 `TaskReceiver.receiveTask`，完成幂等校验、授权校验、任务入库并返回 `TaskReceiveResponse`。

### 1.2 数据结构
- `IncomingTaskRequest.task` 强制包含 `recipeCode`、`recipeName`、`quantity`、`unit`、`priority`、`deadline` 等字段。
- `recipe.materials[]` 结构为 `name/code/weight/unit/sequence/notes`，用于后续导入 `RecipeImportRequest`。
- `TaskReceiver` 将任务以 `ReceivedTaskEntity` 落库，更新授权发送端的活跃时间并通过 `StateFlow` 通知 UI。

### 1.3 现有限制/痛点
1. **对顶层字段强依赖**：若发送端 JSON 将发送端信息封装在 `sender` 对象或新增 `schemaVersion`，反序列化会失败（`call.receive<IncomingTaskRequest>()` 无法匹配结构）。
2. **缺少配方落库**：`TaskReceiver` 在收到 `recipe` 时仅打印日志（TODO），没有真正写入 `RecipeRepository`，导致任务与配方未同步。
3. **字段不完全对齐**：目前业务强依赖 `task.recipeCode`/`task.recipeName`，而 PC 端提案中的 `task` 仅包含标题、优先级与数量，需要额外映射逻辑。
4. **安全与版本控制缺失**：没有 `schemaVersion`、`signature` 等字段，难以进行协议演进或接入签名校验。
5. **响应信息有限**：虽然 `TaskReceiveResponse` 包含 `receiverUID/Name`，但没有 `errorCode` 等辅助定位字段。

## 2. 改造提案

### 2.1 目标
1. 兼容 PC 端“局域网配方传输 JSON”提案，使其无需调整即可接入。
2. 在不破坏现有移动端任务处理逻辑的前提下，引入版本、字段映射、签名校验等能力。
3. 落地配方同步存储，让任务与配方保持一致。

### 2.2 结构兼容与适配
| 提案字段 | 现有字段/处理 | 说明 |
| --- | --- | --- |
| `schemaVersion` | 新增字段（默认 `1.0`） | 接口层记录版本，并在响应中透传或提示升级。 |
| `sender.uid/name/ip/appVersion` | 映射为 `senderUID/senderName/senderIP/metadata` | 新建 `LanTransferProposalAdapter` 负责展开。 |
| `task.title/priority/quantity/unit/deadline` | 对应 `task.title/...` | 若缺少 `recipeCode/name`，由适配层从 `recipe` 中补齐（`recipe.code/name`），无法补齐则报错。 |
| `recipe.*` | 映射至 `RecipePayload` | `materials[].id` 写入 `code` 字段，原 `code` 可作为备用 ID。 |
| `signature`（新增） | 接口层校验 | 约定 HMAC(transferId+timestamp+sender.uid)。验签失败直接返回 `errorCode=SIGNATURE_INVALID`。 |

适配步骤：
1. 新增 `LanTransferProposalDto` 与 `LanTransferProposalAdapter`（位于 `com.example.smartdosing.web.transfer`），解析提案 JSON。
2. 在 `/api/transfer/task` 内判断请求头 `Content-Type: application/json+lan-task` 或 JSON 中存在 `schemaVersion` 字段时走适配逻辑，转换为 `IncomingTaskRequest` 再调用现有处理。
3. 记录 `schemaVersion` 与 `signature` 至 `ReceivedTaskEntity` 新增字段，便于溯源。

### 2.3 配方同步与幂等
1. **配方落库**：在 `TaskReceiver.receiveTask` 中检测 `request.recipe`，通过 `RecipePayload.toImportRequest()` 调用 `RecipeRepository` 完成新增/覆盖，并把落库 ID 写回任务记录（若 `recipe.code` 冲突且未设覆盖，则返回 `errorCode=RECIPE_EXISTS`）。
2. **幂等策略**：仍以 `transferId` 为幂等键，若重复，返回 `success=false,errorCode=DUPLICATE_TRANSFER`。在数据库中新增索引确保唯一。
3. **重量校验**：对 `task.quantity`、`recipe.totalWeight`、`materials[].weight` 做 >0 校验；若 `task.quantity` 与 `recipe.totalWeight` 差异 >5%，在响应中加入 `warningCodes=["QUANTITY_MISMATCH"]`。

### 2.4 安全与授权
1. **签名校验**：双方约定密钥，校验 `signature`；失败直接拒绝。
2. **授权扩展**：继续沿用 `deviceDao.isSenderAuthorized`，但将 `sender.appVersion`、`schemaVersion` 写入授权记录，用于兼容性分析。
3. **IP 记录**：在 `ReceivedTaskEntity` 新增 `senderIP` 字段，便于问题追踪。

### 2.5 响应与错误码
统一返回：
```json
{
  "success": true/false,
  "message": "描述",
  "transferId": "...",
  "receivedTaskId": "...",
  "receiverUID": "...",
  "receiverName": "...",
  "timestamp": 1732710055000,
  "schemaVersion": "1.0",
  "errorCode": null,
  "warningCodes": []
}
```
常见错误码：
- `UNSUPPORTED_VERSION`：`schemaVersion` 低于服务端最小版本。
- `SIGNATURE_INVALID`：签名验证失败。
- `DUPLICATE_TRANSFER`：`transferId` 已存在。
- `RECIPE_EXISTS`：配方编码冲突且未允许覆盖。
- `FIELD_MISSING`：关键字段缺失（如 `recipe.code`）。

### 2.6 实施步骤
1. **接口层改造**：新增 DTO + 适配层，Ktor 中根据内容动态解析。
2. **数据库迁移**：为 `ReceivedTaskEntity` 增加 `schemaVersion`、`signature`、`senderIP`、`warningCodes` 字段；同步更新 DAO 与实体。
3. **业务逻辑补齐**：完成配方落库、重量校验、错误码返回。
4. **文档更新**：在《Web服务使用指南》中新增“局域网 JSON 任务传输方案”章节，示例请求/响应与错误码表。
5. **联调测试**：使用 PC 端样例 JSON 覆盖新增/覆盖/验签失败/重复传输等场景，确保返回结果符合提案。

通过以上改造，可在不破坏现有移动端逻辑的前提下接入 PC 端 JSON 提案，增强协议演进、数据一致性与安全性。

## 3. JSON 方案开发计划

| 阶段 | 时长/负责人 | 主要工作 | 产出 |
| ---- | ----------- | -------- | ---- |
| 需求冻结 | 0.5 天 / 产品&后端 | 最终确认字段、错误码、签名算法、版本策略，整理 PC 端示例 JSON | 《局域网 JSON 字段对照表》 |
| 适配层实现 | 2 天 / 后端 | 新增 `LanTransferProposalDto` & `LanTransferProposalAdapter`；在 `WebServerManager.kt` 中按 `schemaVersion` 判断走适配流程；添加验签逻辑 | 适配层代码、单元测试（字段映射、验签、异常） |
| DB & 业务扩展 | 1.5 天 / 后端 | `ReceivedTaskEntity` 增加 `schemaVersion/signature/senderIP/warningCodes` 字段；完成配方落库与幂等冲突处理；返回统一错误码 | 数据库 migration、Repository 改动、集成测试 |
| 文档与配置 | 1 天 / 后端 + 技术文档 | 更新《Web服务使用指南》、生成 curl 示例、补充错误码表；输出配置说明（密钥、最小版本） | 文档、配置指南 |
| 联调与验收 | 1 天 / 后端+PC 团队 | 与 PC 端联调自动推送流程：新增、覆盖、重复流水、签名失败等场景；整理问题清单并修复 | 联调报告、回归测试结果 |

### 风险与缓解
- **验签失败**：提前由双方确认密钥分发方式，并在开发阶段提供 Debug 日志与开关。
- **数据库 migration 风险**：在开发期准备数据脚本与回滚方案，确保迁移在应用启动时自动执行。
- **字段缺失导致的回退**：适配层要提供兼容逻辑（如缺 `recipeCode` 时尝试使用 `recipe.code`），并在响应中返回明确 `errorCode`，便于 PC 端快速修复。

完成以上计划后，PC 端即可通过 JSON 接口稳定下发任务/配方，实现完全自动化的局域网传输。
