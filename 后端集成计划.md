âš ï¸ æœ¬æ–‡æè¿°çš„æ˜¯ç”Ÿäº§æŠ•æ–™é˜¶æ®µå†…å®¹ï¼Œå·²å½’æ¡£ï¼Œä»…ä¾›å‚è€ƒã€‚

ï»¿# SmartDosing åç«¯å¼€å‘ä¸ SQLite é›†æˆè®¡åˆ’ v2.0

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 ç°çŠ¶åˆ†æ
- **æ•°æ®å­˜å‚¨ç°çŠ¶**ï¼š
  - ä¸šåŠ¡æ•°æ®ï¼ˆé…æ–¹ã€ææ–™ã€æ¨¡æ¿ï¼‰å…¨éƒ¨ä¿å­˜åœ¨å†…å­˜ä»“åº“ï¼ˆ`RecipeRepository`ã€`TemplateRepository`ï¼‰
  - åº”ç”¨é‡å¯åæ•°æ®ä¸¢å¤±ï¼Œæ— æ³•æŒä¹…åŒ–ä¿å­˜
  - Web ç«¯å¯¼å…¥åŠŸèƒ½å·²æ”¯æŒ CSV/Excelï¼Œä½†æ•°æ®ä»å†™å…¥å†…å­˜é›†åˆ
  - ç¼ºä¹ç»Ÿä¸€çš„æŒä¹…åŒ–å±‚ï¼Œæ— æ³•è¿›è¡Œå¤æ‚æŸ¥è¯¢ã€ç­›é€‰ã€ç»Ÿè®¡

- **æŠ€æœ¯æ¶æ„ç°çŠ¶**ï¼š
  - âœ… å®Œå–„çš„æ•°æ®æ¨¡å‹ï¼ˆRecipeã€Materialã€Templateç­‰ï¼‰
  - âœ… å®Œæ•´çš„REST APIï¼ˆKtor WebæœåŠ¡å™¨ï¼Œ8080ç«¯å£ï¼‰
  - âœ… Repositoryæ¨¡å¼æ¶æ„è®¾è®¡è‰¯å¥½
  - âœ… CSV/Excelå¯¼å…¥åŠŸèƒ½å®Œæ•´
  - âŒ ç¼ºä¹æ•°æ®æŒä¹…åŒ–å±‚
  - âŒ æ— æ•°æ®å¤‡ä»½å’Œæ¢å¤æœºåˆ¶

### 1.2 é›†æˆç›®æ ‡
- **æ ¸å¿ƒç›®æ ‡**ï¼š
  - å¼•å…¥æœ¬åœ° SQLite æ•°æ®åº“ï¼Œä½¿ç”¨ androidx.room åº“å®ç°å¯æŒä¹…åŒ–çš„ CRUD
  - å°† Ktor Web æœåŠ¡ã€å¯¼å…¥æ¨¡å—ã€App ä¾§ UI å…¨é‡åˆ‡æ¢åˆ°æ•°æ®åº“é©±åŠ¨
  - ä¿æŒç°æœ‰APIæ¥å£ä¸å˜ï¼Œé™ä½Webç«¯é›†æˆæˆæœ¬

- **æ‰©å±•ç›®æ ‡**ï¼š
  - ä¸ºåç»­å¤šç«¯åŒæ­¥ã€å¤‡ä»½è¿˜åŸã€æƒé™æ§åˆ¶ç­‰åŠŸèƒ½æ‰“ä¸‹åŸºç¡€
  - æ”¯æŒå¤§æ•°æ®é‡åœºæ™¯ä¸‹çš„é«˜æ€§èƒ½æŸ¥è¯¢å’Œæ‰¹é‡æ“ä½œ
  - å»ºç«‹å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ•°æ®æ¢å¤æœºåˆ¶

## 2. æ¶æ„æ¢³ç†

### 2.1 ç°æœ‰æ¨¡å—åˆ†æ
| æ¨¡å— | ç°æœ‰èŒè´£ | é›†æˆå½±å“ | ä¼˜å…ˆçº§ |
| --- | --- | --- | --- |
| `RecipeRepository` | ç®¡ç†é…æ–¹æ•°æ®ï¼Œå†…å­˜ `MutableStateFlow` | **é‡ç‚¹æ”¹é€ **ï¼šåˆ‡æ¢åˆ°Room DAOï¼Œä¿æŒFlowæ¥å£ | P0 |
| `TemplateRepository` | æä¾›é»˜è®¤æ¨¡æ¿ã€å¯¼å‡ºåŠŸèƒ½ | æ¨¡æ¿è‡ªå®šä¹‰éƒ¨åˆ†éœ€ä¿å­˜åˆ°DBï¼Œé»˜è®¤æ¨¡æ¿å¯å†…å­˜ç»´æŠ¤ | P1 |
| `RecipeImportManager` | è§£æ CSV/Excelï¼Œè°ƒç”¨ `RecipeRepository.addRecipe` | è§£æé€»è¾‘ä¿ç•™ï¼Œæ”¹ä¸ºæ‰¹é‡äº‹åŠ¡å†™å…¥ | P0 |
| `WebServerManager` | Ktor è·¯ç”±ã€API å“åº” | APIæ¥å£ä¿æŒä¸å˜ï¼Œå†…éƒ¨è°ƒç”¨æ”¹ä¸ºDAO | P1 |
| App UIï¼ˆComposeï¼‰ | é€šè¿‡ä»“åº“è·å–åˆ—è¡¨/è¯¦æƒ… | ä»“åº“æ¥å£ä¿æŒä¸å˜ï¼Œéœ€éªŒè¯å“åº”æ€§èƒ½ | P2 |

### 2.2 æ–°å¢æ¨¡å—
| æ¨¡å— | èŒè´£ | å®ç°æ–¹å¼ |
| --- | --- | --- |
| `SmartDosingDatabase` | Roomæ•°æ®åº“ä¸»ç±» | å®šä¹‰æ•°æ®åº“ç‰ˆæœ¬ã€å®ä½“ã€DAO |
| `RecipeDao`/`MaterialDao` | æ•°æ®è®¿é—®å¯¹è±¡ | æä¾›CRUDã€å¤æ‚æŸ¥è¯¢ã€æ‰¹é‡æ“ä½œ |
| `DatabaseModule` | ä¾èµ–æ³¨å…¥æ¨¡å— | æä¾›æ•°æ®åº“å•ä¾‹ã€DAOå®ä¾‹ |
| `DataMapper` | æ•°æ®è½¬æ¢å™¨ | Entity â†” ä¸šåŠ¡æ¨¡å‹è½¬æ¢ |
| `DatabaseErrorHandler` | é”™è¯¯å¤„ç†å™¨ | å¤„ç†æ•°æ®åº“å¼‚å¸¸ã€å¤‡ä»½æ¢å¤ |

## 3. æ•°æ®åº“è®¾è®¡

### 3.1 æ ¸å¿ƒè¡¨ç»“æ„

#### 3.1.1 é…æ–¹ä¸»è¡¨ (recipes)
```sql
CREATE TABLE recipes (
    id TEXT PRIMARY KEY,                    -- é…æ–¹å”¯ä¸€æ ‡è¯†
    code TEXT UNIQUE NOT NULL,              -- é…æ–¹ç¼–ç ï¼ˆä¸šåŠ¡å”¯ä¸€æ ‡è¯†ï¼‰
    name TEXT NOT NULL,                     -- é…æ–¹åç§°
    category TEXT NOT NULL,                 -- ä¸€çº§åˆ†ç±»ï¼ˆé¦™ç²¾ã€é…¸ç±»ç­‰ï¼‰
    sub_category TEXT DEFAULT '',           -- äºŒçº§åˆ†ç±»
    customer TEXT DEFAULT '',               -- å®¢æˆ·åç§°
    batch_no TEXT DEFAULT '',               -- æ‰¹æ¬¡å·
    version TEXT DEFAULT '1.0',             -- ç‰ˆæœ¬å·
    description TEXT DEFAULT '',            -- é…æ–¹æè¿°
    total_weight REAL NOT NULL,             -- æ€»é‡é‡
    create_time TEXT NOT NULL,              -- åˆ›å»ºæ—¶é—´ (ISO 8601æ ¼å¼)
    update_time TEXT NOT NULL,              -- æ›´æ–°æ—¶é—´
    last_used TEXT,                         -- æœ€åä½¿ç”¨æ—¶é—´
    usage_count INTEGER DEFAULT 0,         -- ä½¿ç”¨æ¬¡æ•°
    status TEXT DEFAULT 'ACTIVE',          -- çŠ¶æ€ï¼šACTIVE/INACTIVE/DRAFT/ARCHIVED
    priority TEXT DEFAULT 'NORMAL',        -- ä¼˜å…ˆçº§ï¼šLOW/NORMAL/HIGH/URGENT
    creator TEXT DEFAULT '',                -- åˆ›å»ºè€…
    reviewer TEXT DEFAULT ''                -- å®¡æ ¸è€…
);
```

#### 3.1.2 ææ–™è¡¨ (materials)
```sql
CREATE TABLE materials (
    id TEXT PRIMARY KEY,                    -- ææ–™å”¯ä¸€æ ‡è¯†
    recipe_id TEXT NOT NULL,                -- å…³è”é…æ–¹ID
    name TEXT NOT NULL,                     -- ææ–™åç§°
    weight REAL NOT NULL,                   -- é‡é‡
    unit TEXT DEFAULT 'g',                  -- å•ä½
    sequence INTEGER DEFAULT 1,            -- æŠ•æ–™é¡ºåº
    notes TEXT DEFAULT '',                  -- å¤‡æ³¨
    FOREIGN KEY (recipe_id) REFERENCES recipes(id) ON DELETE CASCADE
);
```

#### 3.1.3 é…æ–¹æ ‡ç­¾å…³ç³»è¡¨ (recipe_tags)
```sql
CREATE TABLE recipe_tags (
    recipe_id TEXT NOT NULL,                -- é…æ–¹ID
    tag TEXT NOT NULL,                      -- æ ‡ç­¾åç§°
    PRIMARY KEY (recipe_id, tag),
    FOREIGN KEY (recipe_id) REFERENCES recipes(id) ON DELETE CASCADE
);
```

#### 3.1.4 æ¨¡æ¿è¡¨ (templates)
```sql
CREATE TABLE templates (
    id TEXT PRIMARY KEY,                    -- æ¨¡æ¿å”¯ä¸€æ ‡è¯†
    name TEXT NOT NULL,                     -- æ¨¡æ¿åç§°
    description TEXT DEFAULT '',            -- æ¨¡æ¿æè¿°
    version INTEGER DEFAULT 1,             -- ç‰ˆæœ¬å·
    updated_at TEXT NOT NULL,               -- æ›´æ–°æ—¶é—´
    is_default BOOLEAN DEFAULT FALSE,      -- æ˜¯å¦ä¸ºé»˜è®¤æ¨¡æ¿
    created_by TEXT DEFAULT 'SYSTEM'       -- åˆ›å»ºè€…ï¼ˆSYSTEM/USERï¼‰
);
```

#### 3.1.5 æ¨¡æ¿å­—æ®µè¡¨ (template_fields)
```sql
CREATE TABLE template_fields (
    id TEXT PRIMARY KEY,                    -- å­—æ®µå”¯ä¸€æ ‡è¯†
    template_id TEXT NOT NULL,              -- å…³è”æ¨¡æ¿ID
    field_key TEXT NOT NULL,                -- å­—æ®µé”®å
    label TEXT NOT NULL,                    -- æ˜¾ç¤ºæ ‡ç­¾
    description TEXT DEFAULT '',            -- å­—æ®µæè¿°
    required BOOLEAN DEFAULT TRUE,         -- æ˜¯å¦å¿…å¡«
    example TEXT DEFAULT '',                -- ç¤ºä¾‹å€¼
    field_order INTEGER DEFAULT 0,         -- å­—æ®µé¡ºåº
    FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE CASCADE
);
```

#### 3.1.6 å¯¼å…¥æ—¥å¿—è¡¨ (import_logs)
```sql
CREATE TABLE import_logs (
    id TEXT PRIMARY KEY,                    -- æ—¥å¿—å”¯ä¸€æ ‡è¯†
    file_name TEXT NOT NULL,                -- åŸå§‹æ–‡ä»¶å
    file_size INTEGER NOT NULL,             -- æ–‡ä»¶å¤§å°(å­—èŠ‚)
    file_type TEXT NOT NULL,                -- æ–‡ä»¶ç±»å‹(CSV/EXCEL)
    success_count INTEGER DEFAULT 0,       -- æˆåŠŸå¯¼å…¥æ•°é‡
    failed_count INTEGER DEFAULT 0,        -- å¤±è´¥æ•°é‡
    error_details TEXT,                     -- é”™è¯¯è¯¦æƒ…(JSONæ ¼å¼)
    import_time TEXT NOT NULL,              -- å¯¼å…¥æ—¶é—´
    import_duration INTEGER DEFAULT 0,     -- å¯¼å…¥è€—æ—¶(æ¯«ç§’)
    imported_by TEXT DEFAULT 'WEB'         -- å¯¼å…¥æ¥æº(WEB/APP)
);
```

### 3.2 ç´¢å¼•è®¾è®¡
```sql
-- é…æ–¹è¡¨ç´¢å¼•
CREATE UNIQUE INDEX idx_recipes_code ON recipes(code);
CREATE INDEX idx_recipes_category ON recipes(category);
CREATE INDEX idx_recipes_customer ON recipes(customer);
CREATE INDEX idx_recipes_status ON recipes(status);
CREATE INDEX idx_recipes_last_used ON recipes(last_used);
CREATE INDEX idx_recipes_create_time ON recipes(create_time);

-- ææ–™è¡¨ç´¢å¼•
CREATE INDEX idx_materials_recipe_id ON materials(recipe_id);
CREATE INDEX idx_materials_sequence ON materials(recipe_id, sequence);

-- æ¨¡æ¿å­—æ®µè¡¨ç´¢å¼•
CREATE INDEX idx_template_fields_template_id ON template_fields(template_id);
CREATE INDEX idx_template_fields_order ON template_fields(template_id, field_order);

-- å¯¼å…¥æ—¥å¿—ç´¢å¼•
CREATE INDEX idx_import_logs_time ON import_logs(import_time);
CREATE INDEX idx_import_logs_type ON import_logs(file_type);
```

### 3.3 æ•°æ®çº¦æŸ
- **referential_integrity**: å¯ç”¨å¤–é”®çº¦æŸ
- **unique_constraints**: é…æ–¹ç¼–ç å…¨å±€å”¯ä¸€
- **check_constraints**: é‡é‡å¿…é¡»å¤§äº0ï¼ŒçŠ¶æ€å’Œä¼˜å…ˆçº§æšä¸¾å€¼æ£€æŸ¥
- **cascade_deletes**: åˆ é™¤é…æ–¹æ—¶çº§è”åˆ é™¤ææ–™å’Œæ ‡ç­¾

## 4. Roomå®ä½“è®¾è®¡

### 4.1 æ ¸å¿ƒå®ä½“ç±»

#### 4.1.1 é…æ–¹å®ä½“ (RecipeEntity)
```kotlin
@Entity(
    tableName = "recipes",
    indices = [
        Index(value = ["code"], unique = true),
        Index(value = ["category"]),
        Index(value = ["customer"]),
        Index(value = ["status"]),
        Index(value = ["last_used"]),
        Index(value = ["create_time"])
    ]
)
data class RecipeEntity(
    @PrimaryKey val id: String,
    val code: String,
    val name: String,
    val category: String,
    @ColumnInfo(name = "sub_category") val subCategory: String = "",
    val customer: String = "",
    @ColumnInfo(name = "batch_no") val batchNo: String = "",
    val version: String = "1.0",
    val description: String = "",
    @ColumnInfo(name = "total_weight") val totalWeight: Double,
    @ColumnInfo(name = "create_time") val createTime: String,
    @ColumnInfo(name = "update_time") val updateTime: String,
    @ColumnInfo(name = "last_used") val lastUsed: String? = null,
    @ColumnInfo(name = "usage_count") val usageCount: Int = 0,
    val status: String = "ACTIVE",
    val priority: String = "NORMAL",
    val creator: String = "",
    val reviewer: String = ""
)
```

#### 4.1.2 ææ–™å®ä½“ (MaterialEntity)
```kotlin
@Entity(
    tableName = "materials",
    indices = [
        Index(value = ["recipe_id"]),
        Index(value = ["recipe_id", "sequence"])
    ],
    foreignKeys = [
        ForeignKey(
            entity = RecipeEntity::class,
            parentColumns = ["id"],
            childColumns = ["recipe_id"],
            onDelete = ForeignKey.CASCADE
        )
    ]
)
data class MaterialEntity(
    @PrimaryKey val id: String,
    @ColumnInfo(name = "recipe_id") val recipeId: String,
    val name: String,
    val weight: Double,
    val unit: String = "g",
    val sequence: Int = 1,
    val notes: String = ""
)
```

#### 4.1.3 å…³ç³»æ˜ å°„ç±»
```kotlin
data class RecipeWithMaterials(
    @Embedded val recipe: RecipeEntity,
    @Relation(
        parentColumn = "id",
        entityColumn = "recipe_id"
    )
    val materials: List<MaterialEntity>,
    @Relation(
        parentColumn = "id",
        entityColumn = "recipe_id",
        entity = RecipeTagEntity::class,
        projection = ["tag"]
    )
    val tags: List<String>
)
```

### 4.2 DAO æ¥å£è®¾è®¡

#### 4.2.1 é…æ–¹DAO (RecipeDao)
```kotlin
@Dao
interface RecipeDao {

    // åŸºç¡€æŸ¥è¯¢
    @Query("SELECT * FROM recipes ORDER BY create_time DESC")
    fun getAllRecipesFlow(): Flow<List<RecipeEntity>>

    @Query("SELECT * FROM recipes WHERE id = :id")
    suspend fun getRecipeById(id: String): RecipeEntity?

    @Query("SELECT * FROM recipes WHERE code = :code")
    suspend fun getRecipeByCode(code: String): RecipeEntity?

    // åˆ†é¡µæŸ¥è¯¢
    @Query("""
        SELECT * FROM recipes
        WHERE (:category IS NULL OR category = :category)
        AND (:customer IS NULL OR customer = :customer)
        AND (:status IS NULL OR status = :status)
        AND (:searchText IS NULL OR
             name LIKE '%' || :searchText || '%' OR
             code LIKE '%' || :searchText || '%' OR
             description LIKE '%' || :searchText || '%')
        ORDER BY
        CASE WHEN :sortBy = 'CREATE_TIME' AND :sortOrder = 'DESC' THEN create_time END DESC,
        CASE WHEN :sortBy = 'CREATE_TIME' AND :sortOrder = 'ASC' THEN create_time END ASC,
        CASE WHEN :sortBy = 'NAME' AND :sortOrder = 'ASC' THEN name END ASC,
        CASE WHEN :sortBy = 'NAME' AND :sortOrder = 'DESC' THEN name END DESC,
        CASE WHEN :sortBy = 'USAGE_COUNT' AND :sortOrder = 'DESC' THEN usage_count END DESC
        LIMIT :limit OFFSET :offset
    """)
    suspend fun getRecipesPaged(
        category: String?,
        customer: String?,
        status: String?,
        searchText: String?,
        sortBy: String,
        sortOrder: String,
        limit: Int,
        offset: Int
    ): List<RecipeEntity>

    // ç»Ÿè®¡æŸ¥è¯¢
    @Query("SELECT COUNT(*) FROM recipes")
    suspend fun getRecipeCount(): Int

    @Query("SELECT COUNT(*) FROM recipes WHERE category = :category")
    suspend fun getRecipeCountByCategory(category: String): Int

    @Query("SELECT DISTINCT category FROM recipes ORDER BY category")
    suspend fun getAllCategories(): List<String>

    @Query("SELECT DISTINCT customer FROM recipes WHERE customer != '' ORDER BY customer")
    suspend fun getAllCustomers(): List<String>

    // å¢åˆ æ”¹
    @Insert(onConflict = OnConflictStrategy.ABORT)
    suspend fun insertRecipe(recipe: RecipeEntity): Long

    @Insert(onConflict = OnConflictStrategy.ABORT)
    suspend fun insertRecipes(recipes: List<RecipeEntity>)

    @Update
    suspend fun updateRecipe(recipe: RecipeEntity)

    @Delete
    suspend fun deleteRecipe(recipe: RecipeEntity)

    @Query("DELETE FROM recipes WHERE id = :id")
    suspend fun deleteRecipeById(id: String)

    // æ‰¹é‡æ“ä½œ
    @Transaction
    suspend fun insertRecipeWithMaterials(
        recipe: RecipeEntity,
        materials: List<MaterialEntity>,
        tags: List<String>
    ) {
        insertRecipe(recipe)
        insertMaterials(materials)
        insertRecipeTags(tags.map { RecipeTagEntity(recipe.id, it) })
    }

    @Insert
    suspend fun insertMaterials(materials: List<MaterialEntity>)

    @Insert(onConflict = OnConflictStrategy.IGNORE)
    suspend fun insertRecipeTags(tags: List<RecipeTagEntity>)

    // å…³ç³»æŸ¥è¯¢
    @Transaction
    @Query("SELECT * FROM recipes WHERE id = :recipeId")
    suspend fun getRecipeWithMaterials(recipeId: String): RecipeWithMaterials?

    @Transaction
    @Query("SELECT * FROM recipes ORDER BY create_time DESC")
    fun getAllRecipesWithMaterialsFlow(): Flow<List<RecipeWithMaterials>>
}
```

### 4.3 æ•°æ®åº“ä¸»ç±»
```kotlin
@Database(
    entities = [
        RecipeEntity::class,
        MaterialEntity::class,
        RecipeTagEntity::class,
        TemplateEntity::class,
        TemplateFieldEntity::class,
        ImportLogEntity::class
    ],
    version = 1,
    exportSchema = true
)
@TypeConverters(DatabaseConverters::class)
abstract class SmartDosingDatabase : RoomDatabase() {

    abstract fun recipeDao(): RecipeDao
    abstract fun materialDao(): MaterialDao
    abstract fun templateDao(): TemplateDao
    abstract fun importLogDao(): ImportLogDao

    companion object {
        const val DATABASE_NAME = "smartdosing.db"

        @Volatile
        private var INSTANCE: SmartDosingDatabase? = null

        fun getDatabase(context: Context): SmartDosingDatabase {
            return INSTANCE ?: synchronized(this) {
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    SmartDosingDatabase::class.java,
                    DATABASE_NAME
                )
                .addCallback(DatabaseCallback())
                .fallbackToDestructiveMigration()
                .build()
                INSTANCE = instance
                instance
            }
        }
    }

    private class DatabaseCallback : Callback() {
        override fun onCreate(db: SupportSQLiteDatabase) {
            super.onCreate(db)
            // é¦–æ¬¡åˆ›å»ºæ—¶åœ¨åå°çº¿ç¨‹åˆå§‹åŒ–æ•°æ®
            CoroutineScope(Dispatchers.IO).launch {
                populateInitialData()
            }
        }

        private suspend fun populateInitialData() {
            INSTANCE?.let { database ->
                // æ’å…¥é»˜è®¤æ¨¡æ¿
                // æ’å…¥ç¤ºä¾‹é…æ–¹ï¼ˆå¯é€‰ï¼‰
            }
        }
    }
}
```

## 5. æ•°æ®æ˜ å°„å™¨è®¾è®¡

### 5.1 Entity â†” ä¸šåŠ¡æ¨¡å‹è½¬æ¢
```kotlin
object DataMapper {

    // Recipeè½¬æ¢
    fun RecipeEntity.toDomainModel(materials: List<MaterialEntity>, tags: List<String>): Recipe {
        return Recipe(
            id = id,
            code = code,
            name = name,
            category = category,
            subCategory = subCategory,
            customer = customer,
            batchNo = batchNo,
            version = version,
            description = description,
            materials = materials.map { it.toDomainModel() },
            totalWeight = totalWeight,
            createTime = createTime,
            updateTime = updateTime,
            lastUsed = lastUsed,
            usageCount = usageCount,
            status = RecipeStatus.valueOf(status),
            priority = RecipePriority.valueOf(priority),
            tags = tags,
            creator = creator,
            reviewer = reviewer
        )
    }

    fun Recipe.toEntity(): RecipeEntity {
        return RecipeEntity(
            id = id,
            code = code,
            name = name,
            category = category,
            subCategory = subCategory,
            customer = customer,
            batchNo = batchNo,
            version = version,
            description = description,
            totalWeight = totalWeight,
            createTime = createTime,
            updateTime = updateTime,
            lastUsed = lastUsed,
            usageCount = usageCount,
            status = status.name,
            priority = priority.name,
            creator = creator,
            reviewer = reviewer
        )
    }

    // Materialè½¬æ¢
    fun MaterialEntity.toDomainModel(): Material {
        return Material(
            id = id,
            name = name,
            weight = weight,
            unit = unit,
            sequence = sequence,
            notes = notes
        )
    }

    fun Material.toEntity(recipeId: String): MaterialEntity {
        return MaterialEntity(
            id = id,
            recipeId = recipeId,
            name = name,
            weight = weight,
            unit = unit,
            sequence = sequence,
            notes = notes
        )
    }
}
```

## 6. é›†æˆå®æ–½æ–¹æ¡ˆ

### 6.1 é˜¶æ®µè§„åˆ’

#### **é˜¶æ®µ 0ï¼šåŸºç¡€å‡†å¤‡ (1å¤©)**
- âœ… **æŠ€æœ¯é€‰å‹ç¡®è®¤**ï¼šä½¿ç”¨ `androidx.room` ä½œä¸ºæ•°æ®åº“æ¡†æ¶
- ğŸ“¦ **ä¾èµ–æ·»åŠ **ï¼šåœ¨ `app/build.gradle.kts` ä¸­æ·»åŠ Roomç›¸å…³ä¾èµ–
- ğŸ“‹ **æ•°æ®åº“è®¾è®¡ç¡®è®¤**ï¼šå®Œå–„è¡¨ç»“æ„ã€ç´¢å¼•ã€çº¦æŸè®¾è®¡
- ğŸ—ï¸ **é¡¹ç›®ç»“æ„è°ƒæ•´**ï¼šåˆ›å»º `database/` åŒ…ç»“æ„

#### **é˜¶æ®µ 1ï¼šæ•°æ®è®¿é—®å±‚å®ç° (2-3å¤©)**
- ğŸ—ƒï¸ **å®ä½“ç±»å¼€å‘**ï¼š
  - å®ç° `RecipeEntity`, `MaterialEntity`, `RecipeTagEntity` ç­‰Roomå®ä½“
  - å®šä¹‰å…³ç³»æ˜ å°„ç±» `RecipeWithMaterials`
  - æ·»åŠ ç±»å‹è½¬æ¢å™¨ `DatabaseConverters`
- ğŸ” **DAOæ¥å£å®ç°**ï¼š
  - `RecipeDao`ï¼šåŒ…å«CRUDã€åˆ†é¡µæŸ¥è¯¢ã€ç»Ÿè®¡æŸ¥è¯¢
  - `MaterialDao`ï¼šææ–™çš„å¢åˆ æ”¹æŸ¥å’Œæ‰¹é‡æ“ä½œ
  - `TemplateDao`ï¼šæ¨¡æ¿ç®¡ç†ç›¸å…³æ“ä½œ
  - `ImportLogDao`ï¼šå¯¼å…¥æ—¥å¿—è®°å½•
- ğŸ—„ï¸ **æ•°æ®åº“ä¸»ç±»**ï¼š
  - `SmartDosingDatabase` é…ç½®
  - æ•°æ®åº“å›è°ƒå’Œåˆå§‹åŒ–é€»è¾‘
  - æ•°æ®è¿ç§»ç­–ç•¥
- ğŸ”„ **æ•°æ®æ˜ å°„å™¨**ï¼š
  - Entity â†” ä¸šåŠ¡æ¨¡å‹åŒå‘è½¬æ¢
  - æ‰©å±•å‡½æ•°å¼APIè®¾è®¡

#### **é˜¶æ®µ 2ï¼šRepositoryå±‚æ”¹é€  (2å¤©)**
- ğŸª **RecipeRepositoryé‡æ„**ï¼š
  - ä»å†…å­˜å­˜å‚¨åˆ‡æ¢åˆ°Room DAO
  - ä¿æŒåŸæœ‰å…¬å¼€æ¥å£ï¼Œå†…éƒ¨å®ç°æ”¹ä¸ºæ•°æ®åº“æ“ä½œ
  - æ·»åŠ  Flow/StateFlow å“åº”å¼æ•°æ®æµ
  - å®ç°å¤æ‚æŸ¥è¯¢å’Œç­›é€‰åŠŸèƒ½
- ğŸ“ **TemplateRepositoryæ”¹é€ **ï¼š
  - æ¨¡æ¿çš„æŒä¹…åŒ–å­˜å‚¨å’Œè‡ªå®šä¹‰åŠŸèƒ½
  - ä¿ç•™é»˜è®¤æ¨¡æ¿çš„åˆå§‹åŒ–é€»è¾‘
- ğŸ”„ **æ•°æ®è¿ç§»é€»è¾‘**ï¼š
  - é¦–æ¬¡å¯åŠ¨æ—¶çš„ç¤ºä¾‹æ•°æ®æ’å…¥
  - ä»å†…å­˜æ•°æ®åˆ°æ•°æ®åº“çš„è¿ç§»å·¥å…·

#### **é˜¶æ®µ 3ï¼šå¯¼å…¥æ¨¡å—æ”¹é€  (1å¤©)**
- ğŸ“¥ **RecipeImportManageré‡æ„**ï¼š
  - è§£æé€»è¾‘ä¿æŒä¸å˜
  - æ”¹ä¸ºä½¿ç”¨Roomäº‹åŠ¡è¿›è¡Œæ‰¹é‡æ’å…¥
  - ä¼˜åŒ–å¤§æ–‡ä»¶å¯¼å…¥æ€§èƒ½
  - å®Œå–„å¯¼å…¥æ—¥å¿—è®°å½•
- ğŸ“Š **å¯¼å…¥ç»Ÿè®¡ä¼˜åŒ–**ï¼š
  - æ›´è¯¦ç»†çš„ `ImportSummary` ä¿¡æ¯
  - å¤±è´¥è®°å½•çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

#### **é˜¶æ®µ 4ï¼šWebæœåŠ¡å±‚é›†æˆ (1å¤©)**
- ğŸŒ **APIæ¥å£ä¿æŒ**ï¼š
  - Ktorè·¯ç”±å’Œå“åº”æ ¼å¼ä¸å˜
  - å†…éƒ¨è°ƒç”¨æ”¹ä¸ºRepositoryæ–°æ¥å£
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼š
  - æ·»åŠ åˆ†é¡µæ”¯æŒ
  - ä¼˜åŒ–å¤æ‚æŸ¥è¯¢æ€§èƒ½
- ğŸ“‹ **æ–°å¢åŠŸèƒ½**ï¼š
  - æ•°æ®å¤‡ä»½API
  - å¯¼å…¥æ—¥å¿—æŸ¥è¯¢API

#### **é˜¶æ®µ 5ï¼šæµ‹è¯•ä¸éªŒè¯ (2å¤©)**
- âœ… **å•å…ƒæµ‹è¯•**ï¼š
  - DAOå±‚æµ‹è¯•ï¼ˆä½¿ç”¨in-memoryæ•°æ®åº“ï¼‰
  - Repositoryå±‚æµ‹è¯•
  - æ•°æ®æ˜ å°„å™¨æµ‹è¯•
- ğŸ”— **é›†æˆæµ‹è¯•**ï¼š
  - Web APIç«¯åˆ°ç«¯æµ‹è¯•
  - æ•°æ®å¯¼å…¥æµç¨‹æµ‹è¯•
  - æ•°æ®ä¸€è‡´æ€§éªŒè¯
- ğŸ“± **UIé›†æˆæµ‹è¯•**ï¼š
  - Androidåº”ç”¨ç•Œé¢åŠŸèƒ½éªŒè¯
  - å“åº”å¼æ•°æ®æµæµ‹è¯•
- âš¡ **æ€§èƒ½æµ‹è¯•**ï¼š
  - å¤§æ•°æ®é‡åœºæ™¯æµ‹è¯•
  - æŸ¥è¯¢æ€§èƒ½åŸºå‡†æµ‹è¯•

### 6.2 è¯¦ç»†ä»»åŠ¡æ¸…å•

#### **6.2.1 åŸºç¡€è®¾æ–½ä»»åŠ¡**
- [ ] **build.gradle.kts ä¾èµ–é…ç½®**
  ```kotlin
  implementation "androidx.room:room-runtime:2.6.1"
  implementation "androidx.room:room-ktx:2.6.1"
  kapt "androidx.room:room-compiler:2.6.1"
  ```
- [ ] **åˆ›å»ºæ•°æ®åº“åŒ…ç»“æ„**
  ```
  app/src/main/java/com/example/smartdosing/
  â”œâ”€â”€ database/
  â”‚   â”œâ”€â”€ entities/
  â”‚   â”œâ”€â”€ dao/
  â”‚   â”œâ”€â”€ converters/
  â”‚   â””â”€â”€ SmartDosingDatabase.kt
  ```

#### **6.2.2 æ•°æ®è®¿é—®å±‚ä»»åŠ¡**
- [ ] **å®ä½“ç±»å¼€å‘**
  - [ ] RecipeEntityï¼ˆé…æ–¹å®ä½“ï¼‰
  - [ ] MaterialEntityï¼ˆææ–™å®ä½“ï¼‰
  - [ ] RecipeTagEntityï¼ˆæ ‡ç­¾å…³ç³»å®ä½“ï¼‰
  - [ ] TemplateEntity/TemplateFieldEntityï¼ˆæ¨¡æ¿å®ä½“ï¼‰
  - [ ] ImportLogEntityï¼ˆå¯¼å…¥æ—¥å¿—å®ä½“ï¼‰
  - [ ] RecipeWithMaterialsï¼ˆå…³ç³»æ˜ å°„ç±»ï¼‰
- [ ] **DAOæ¥å£å®ç°**
  - [ ] RecipeDaoï¼ˆå¢åˆ æ”¹æŸ¥ã€åˆ†é¡µã€ç»Ÿè®¡ã€æœç´¢ï¼‰
  - [ ] MaterialDaoï¼ˆææ–™ç®¡ç†ï¼‰
  - [ ] TemplateDaoï¼ˆæ¨¡æ¿ç®¡ç†ï¼‰
  - [ ] ImportLogDaoï¼ˆæ—¥å¿—è®°å½•ï¼‰
- [ ] **æ•°æ®åº“é…ç½®**
  - [ ] SmartDosingDatabaseä¸»ç±»
  - [ ] DatabaseCallbackåˆå§‹åŒ–é€»è¾‘
  - [ ] DatabaseConvertersç±»å‹è½¬æ¢å™¨

#### **6.2.3 ä¸šåŠ¡å±‚æ”¹é€ ä»»åŠ¡**
- [ ] **Repositoryæ”¹é€ **
  - [ ] RecipeRepositoryå®Œæ•´é‡æ„
  - [ ] TemplateRepositoryæ•°æ®åº“é›†æˆ
  - [ ] æ•°æ®æ˜ å°„å™¨DataMapperå®ç°
- [ ] **å¯¼å…¥æ¨¡å—æ”¹é€ **
  - [ ] RecipeImportManageräº‹åŠ¡å¤„ç†
  - [ ] æ‰¹é‡å¯¼å…¥æ€§èƒ½ä¼˜åŒ–
  - [ ] å¯¼å…¥æ—¥å¿—å®Œå–„

#### **6.2.4 æœåŠ¡å±‚é›†æˆä»»åŠ¡**
- [ ] **Web APIé€‚é…**
  - [ ] WebServerManagerè·¯ç”±ä¿æŒ
  - [ ] åˆ†é¡µæŸ¥è¯¢APIä¼˜åŒ–
  - [ ] æ–°å¢å¤‡ä»½æ¢å¤API

#### **6.2.5 æµ‹è¯•éªŒè¯ä»»åŠ¡**
- [ ] **å•å…ƒæµ‹è¯•ç¼–å†™**
  - [ ] RecipeDaoTest
  - [ ] RecipeRepositoryTest
  - [ ] DataMapperTest
- [ ] **é›†æˆæµ‹è¯•ç¼–å†™**
  - [ ] WebAPIç«¯åˆ°ç«¯æµ‹è¯•
  - [ ] æ•°æ®å¯¼å…¥é›†æˆæµ‹è¯•
- [ ] **æ€§èƒ½æµ‹è¯•**
  - [ ] å¤§æ•°æ®é‡æŸ¥è¯¢æµ‹è¯•
  - [ ] æ‰¹é‡å¯¼å…¥æ€§èƒ½æµ‹è¯•

## 7. é”™è¯¯å¤„ç†ä¸å¤‡ä»½æœºåˆ¶

### 7.1 æ•°æ®åº“é”™è¯¯å¤„ç†ç­–ç•¥
```kotlin
class DatabaseErrorHandler(
    private val database: SmartDosingDatabase,
    private val context: Context
) {

    companion object {
        private const val TAG = "DatabaseErrorHandler"
    }

    /**
     * å¤„ç†æ•°æ®åº“æŸå
     */
    suspend fun handleDatabaseCorruption(): Boolean {
        return try {
            // 1. åˆ›å»ºå¤‡ä»½
            val backupFile = createEmergencyBackup()

            // 2. åˆ é™¤æŸåçš„æ•°æ®åº“
            database.close()
            val dbFile = File(context.getDatabasePath(SmartDosingDatabase.DATABASE_NAME).absolutePath)
            dbFile.delete()

            // 3. é‡æ–°åˆ›å»ºæ•°æ®åº“
            val newDatabase = SmartDosingDatabase.getDatabase(context)

            // 4. å°è¯•ä»å¤‡ä»½æ¢å¤
            backupFile?.let { restoreFromBackup(it, newDatabase) }

            true
        } catch (e: Exception) {
            Log.e(TAG, "æ•°æ®åº“æ¢å¤å¤±è´¥", e)
            false
        }
    }

    /**
     * å¤„ç†çº¦æŸè¿åå¼‚å¸¸
     */
    suspend fun handleConstraintViolation(error: SQLiteConstraintException): DatabaseError {
        return when {
            error.message?.contains("UNIQUE constraint failed: recipes.code") == true -> {
                DatabaseError.DuplicateRecipeCode(extractCodeFromError(error))
            }
            error.message?.contains("FOREIGN KEY constraint failed") == true -> {
                DatabaseError.ForeignKeyViolation("å…³è”æ•°æ®ä¸å­˜åœ¨")
            }
            else -> DatabaseError.UnknownConstraintError(error.message ?: "æœªçŸ¥çº¦æŸé”™è¯¯")
        }
    }

    /**
     * åˆ›å»ºæ•°æ®åº“å¤‡ä»½
     */
    suspend fun createBackup(): File? {
        return try {
            val backupDir = File(context.getExternalFilesDir("backups"), "database")
            backupDir.mkdirs()

            val timestamp = SimpleDateFormat("yyyyMMdd_HHmmss", Locale.getDefault()).format(Date())
            val backupFile = File(backupDir, "smartdosing_backup_$timestamp.db")

            val originalDb = context.getDatabasePath(SmartDosingDatabase.DATABASE_NAME)
            originalDb.copyTo(backupFile, overwrite = true)

            backupFile
        } catch (e: Exception) {
            Log.e(TAG, "åˆ›å»ºå¤‡ä»½å¤±è´¥", e)
            null
        }
    }

    private fun extractCodeFromError(error: SQLiteConstraintException): String {
        // ä»é”™è¯¯æ¶ˆæ¯ä¸­æå–é‡å¤çš„é…æ–¹ç¼–ç 
        val regex = "recipes\\.code.*?'([^']+)'".toRegex()
        return regex.find(error.message ?: "")?.groupValues?.get(1) ?: "æœªçŸ¥"
    }
}

/**
 * æ•°æ®åº“é”™è¯¯ç±»å‹
 */
sealed class DatabaseError {
    data class DuplicateRecipeCode(val code: String) : DatabaseError()
    data class ForeignKeyViolation(val message: String) : DatabaseError()
    data class UnknownConstraintError(val message: String) : DatabaseError()
}
```

### 7.2 æ•°æ®å¤‡ä»½ä¸æ¢å¤API
```kotlin
// åœ¨WebServerManagerä¸­æ·»åŠ å¤‡ä»½ç›¸å…³è·¯ç”±
route("/api/backup") {

    // åˆ›å»ºå¤‡ä»½
    post("/create") {
        try {
            val errorHandler = DatabaseErrorHandler(database, context)
            val backupFile = errorHandler.createBackup()

            if (backupFile != null) {
                call.respond(ApiResponse(
                    success = true,
                    message = "å¤‡ä»½åˆ›å»ºæˆåŠŸ",
                    data = mapOf(
                        "fileName" to backupFile.name,
                        "filePath" to backupFile.absolutePath,
                        "fileSize" to backupFile.length()
                    )
                ))
            } else {
                call.respond(
                    HttpStatusCode.InternalServerError,
                    ApiResponse<Unit>(success = false, message = "å¤‡ä»½åˆ›å»ºå¤±è´¥")
                )
            }
        } catch (e: Exception) {
            call.respond(
                HttpStatusCode.InternalServerError,
                ApiResponse<Unit>(success = false, message = "å¤‡ä»½è¿‡ç¨‹å‡ºé”™: ${e.message}")
            )
        }
    }

    // ä¸‹è½½å¤‡ä»½æ–‡ä»¶
    get("/download/{fileName}") {
        try {
            val fileName = call.parameters["fileName"] ?: return@get call.respond(
                HttpStatusCode.BadRequest,
                ApiResponse<Unit>(success = false, message = "æ–‡ä»¶åä¸èƒ½ä¸ºç©º")
            )

            val backupDir = File(context.getExternalFilesDir("backups"), "database")
            val backupFile = File(backupDir, fileName)

            if (backupFile.exists() && backupFile.isFile) {
                call.response.header(
                    HttpHeaders.ContentDisposition,
                    ContentDisposition.Attachment.withParameter(ContentDisposition.Parameters.FileName, fileName).toString()
                )
                call.respondFile(backupFile)
            } else {
                call.respond(
                    HttpStatusCode.NotFound,
                    ApiResponse<Unit>(success = false, message = "å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨")
                )
            }
        } catch (e: Exception) {
            call.respond(
                HttpStatusCode.InternalServerError,
                ApiResponse<Unit>(success = false, message = "ä¸‹è½½å¤±è´¥: ${e.message}")
            )
        }
    }

    // è·å–å¤‡ä»½åˆ—è¡¨
    get("/list") {
        try {
            val backupDir = File(context.getExternalFilesDir("backups"), "database")
            val backupFiles = if (backupDir.exists()) {
                backupDir.listFiles { file -> file.isFile && file.name.endsWith(".db") }
                    ?.map { file ->
                        mapOf(
                            "fileName" to file.name,
                            "fileSize" to file.length(),
                            "createTime" to SimpleDateFormat("yyyy-MM-dd HH:mm:ss", Locale.getDefault())
                                .format(Date(file.lastModified()))
                        )
                    }?.sortedByDescending { it["createTime"] as String } ?: emptyList()
            } else {
                emptyList()
            }

            call.respond(ApiResponse(success = true, data = backupFiles))
        } catch (e: Exception) {
            call.respond(
                HttpStatusCode.InternalServerError,
                ApiResponse<Unit>(success = false, message = "è·å–å¤‡ä»½åˆ—è¡¨å¤±è´¥: ${e.message}")
            )
        }
    }
}
```

## 8. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 8.1 æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–
```kotlin
// 1. å¯ç”¨WALæ¨¡å¼æå‡å¹¶å‘æ€§èƒ½
@Database(
    // ... å…¶ä»–é…ç½®
)
abstract class SmartDosingDatabase : RoomDatabase() {

    companion object {
        fun getDatabase(context: Context): SmartDosingDatabase {
            return Room.databaseBuilder(context, SmartDosingDatabase::class.java, DATABASE_NAME)
                .setJournalMode(RoomDatabase.JournalMode.WRITE_AHEAD_LOGGING)
                .build()
        }
    }
}

// 2. æ‰¹é‡æ“ä½œä¼˜åŒ–
@Dao
interface RecipeDao {
    @Transaction
    suspend fun insertRecipesBatch(recipesWithMaterials: List<RecipeWithMaterials>) {
        val recipes = recipesWithMaterials.map { it.recipe }
        val materials = recipesWithMaterials.flatMap { rwm ->
            rwm.materials.map { it.copy(recipeId = rwm.recipe.id) }
        }
        val tags = recipesWithMaterials.flatMap { rwm ->
            rwm.tags.map { RecipeTagEntity(rwm.recipe.id, it) }
        }

        insertRecipes(recipes)
        insertMaterials(materials)
        insertRecipeTags(tags)
    }
}
```

### 8.2 åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
```kotlin
// Repositoryå±‚åˆ†é¡µæ”¯æŒ
class RecipeRepository(
    private val recipeDao: RecipeDao
) {

    suspend fun getRecipesPaged(
        filter: RecipeFilter,
        pageSize: Int = 20,
        pageIndex: Int = 0
    ): PagedResult<Recipe> {
        val offset = pageIndex * pageSize

        val entities = recipeDao.getRecipesPaged(
            category = filter.category.takeIf { it.isNotEmpty() },
            customer = filter.customer.takeIf { it.isNotEmpty() },
            status = filter.status?.name,
            searchText = filter.searchText.takeIf { it.isNotEmpty() },
            sortBy = filter.sortBy.name,
            sortOrder = filter.sortOrder.name,
            limit = pageSize,
            offset = offset
        )

        val totalCount = recipeDao.getRecipeCount()
        val recipes = entities.map { entity ->
            val materials = materialDao.getMaterialsByRecipeId(entity.id)
            val tags = recipeDao.getTagsByRecipeId(entity.id)
            DataMapper.toDomainModel(entity, materials, tags)
        }

        return PagedResult(
            data = recipes,
            totalCount = totalCount,
            pageSize = pageSize,
            pageIndex = pageIndex
        )
    }
}

data class PagedResult<T>(
    val data: List<T>,
    val totalCount: Int,
    val pageSize: Int,
    val pageIndex: Int
) {
    val totalPages: Int = (totalCount + pageSize - 1) / pageSize
    val hasNextPage: Boolean = pageIndex < totalPages - 1
    val hasPrevPage: Boolean = pageIndex > 0
}
```

## 9. æµ‹è¯•ç­–ç•¥

### 9.1 DAOå±‚å•å…ƒæµ‹è¯•
```kotlin
@RunWith(AndroidJUnit4::class)
class RecipeDaoTest {

    @get:Rule
    val instantTaskExecutorRule = InstantTaskExecutorRule()

    private lateinit var database: SmartDosingDatabase
    private lateinit var recipeDao: RecipeDao
    private lateinit var materialDao: MaterialDao

    @Before
    fun setupDatabase() {
        database = Room.inMemoryDatabaseBuilder(
            ApplicationProvider.getApplicationContext(),
            SmartDosingDatabase::class.java
        )
        .allowMainThreadQueries()
        .build()

        recipeDao = database.recipeDao()
        materialDao = database.materialDao()
    }

    @After
    fun closeDatabase() {
        database.close()
    }

    @Test
    fun insertRecipe_retrievesRecipe() = runTest {
        // Given
        val recipe = RecipeEntity(
            id = "test-1",
            code = "TEST001",
            name = "æµ‹è¯•é…æ–¹",
            category = "æµ‹è¯•",
            totalWeight = 100.0,
            createTime = "2024-01-01 10:00:00",
            updateTime = "2024-01-01 10:00:00"
        )

        // When
        recipeDao.insertRecipe(recipe)
        val retrieved = recipeDao.getRecipeById("test-1")

        // Then
        assertThat(retrieved).isNotNull()
        assertThat(retrieved?.code).isEqualTo("TEST001")
        assertThat(retrieved?.name).isEqualTo("æµ‹è¯•é…æ–¹")
    }

    @Test
    fun insertDuplicateCode_throwsException() = runTest {
        // Given
        val recipe1 = RecipeEntity(
            id = "test-1", code = "TEST001", name = "é…æ–¹1",
            category = "æµ‹è¯•", totalWeight = 100.0,
            createTime = "2024-01-01 10:00:00", updateTime = "2024-01-01 10:00:00"
        )
        val recipe2 = recipe1.copy(id = "test-2", name = "é…æ–¹2")

        // When & Then
        recipeDao.insertRecipe(recipe1)
        assertThrows<SQLiteConstraintException> {
            runBlocking { recipeDao.insertRecipe(recipe2) }
        }
    }

    @Test
    fun searchRecipes_returnsFilteredResults() = runTest {
        // Given - æ’å…¥å¤šä¸ªæµ‹è¯•é…æ–¹
        val recipes = listOf(
            RecipeEntity("1", "CODE001", "è‹¹æœé¦™ç²¾", "é¦™ç²¾", totalWeight = 100.0, createTime = "2024-01-01 10:00:00", updateTime = "2024-01-01 10:00:00"),
            RecipeEntity("2", "CODE002", "æŸ æª¬é…¸", "é…¸ç±»", totalWeight = 200.0, createTime = "2024-01-02 10:00:00", updateTime = "2024-01-02 10:00:00"),
            RecipeEntity("3", "CODE003", "è‹¹æœé…¸", "é…¸ç±»", totalWeight = 150.0, createTime = "2024-01-03 10:00:00", updateTime = "2024-01-03 10:00:00")
        )
        recipes.forEach { recipeDao.insertRecipe(it) }

        // When - æœç´¢åŒ…å«"è‹¹æœ"çš„é…æ–¹
        val results = recipeDao.getRecipesPaged(
            category = null, customer = null, status = null,
            searchText = "è‹¹æœ", sortBy = "NAME", sortOrder = "ASC",
            limit = 10, offset = 0
        )

        // Then
        assertThat(results).hasSize(2)
        assertThat(results[0].name).isEqualTo("è‹¹æœé…¸")
        assertThat(results[1].name).isEqualTo("è‹¹æœé¦™ç²¾")
    }
}
```

## 10. æ›´æ–°åçš„æ—¶é—´ä¼°ç®—ä¸é‡Œç¨‹ç¢‘

### 10.1 è¯¦ç»†æ—¶é—´è§„åˆ’

| é˜¶æ®µ | ä»»åŠ¡å†…å®¹ | é¢„ä¼°æ—¶é—´ | å…³é”®è¾“å‡ºç‰© | éªŒæ”¶æ ‡å‡† |
|------|---------|---------|-----------|---------|
| **é˜¶æ®µ0** | åŸºç¡€å‡†å¤‡ | **1å¤©** | é¡¹ç›®é…ç½®ã€ä¾èµ–ç®¡ç† | âœ… Roomä¾èµ–é…ç½®å®Œæˆ<br>âœ… æ•°æ®åº“åŒ…ç»“æ„åˆ›å»º |
| **é˜¶æ®µ1** | æ•°æ®è®¿é—®å±‚ | **2-3å¤©** | Entityã€DAOã€Databaseä¸»ç±» | âœ… æ‰€æœ‰å®ä½“ç±»ç¼–è¯‘é€šè¿‡<br>âœ… DAOå•å…ƒæµ‹è¯•é€šè¿‡<br>âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ |
| **é˜¶æ®µ2** | Repositoryæ”¹é€  | **2å¤©** | æ–°Repositoryå®ç° | âœ… åŸæœ‰æ¥å£ä¿æŒå…¼å®¹<br>âœ… æ•°æ®æ­£ç¡®æŒä¹…åŒ–<br>âœ… Flowå“åº”å¼æ›´æ–°æ­£å¸¸ |
| **é˜¶æ®µ3** | å¯¼å…¥æ¨¡å—æ”¹é€  | **1å¤©** | æ–°ImportManager | âœ… CSV/Excelå¯¼å…¥æ­£å¸¸<br>âœ… æ‰¹é‡æ“ä½œäº‹åŠ¡å®Œæ•´<br>âœ… å¯¼å…¥æ—¥å¿—è®°å½•å‡†ç¡® |
| **é˜¶æ®µ4** | WebæœåŠ¡é›†æˆ | **1å¤©** | æ›´æ–°åçš„API | âœ… æ‰€æœ‰ç°æœ‰APIæ­£å¸¸å·¥ä½œ<br>âœ… æ–°å¢å¤‡ä»½APIå¯ç”¨<br>âœ… åˆ†é¡µæŸ¥è¯¢æ€§èƒ½è‰¯å¥½ |
| **é˜¶æ®µ5** | æµ‹è¯•ä¸éªŒè¯ | **2å¤©** | æµ‹è¯•å¥—ä»¶ | âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡>80%<br>âœ… é›†æˆæµ‹è¯•é€šè¿‡<br>âœ… æ€§èƒ½åŸºå‡†è¾¾æ ‡ |
| **æ€»è®¡** | **å…¨éƒ¨é˜¶æ®µ** | **ğŸ¯ 9-10å¤©** | å®Œæ•´SQLiteé›†æˆ | âœ… æ•°æ®æŒä¹…åŒ–å¯é <br>âœ… æ€§èƒ½æ»¡è¶³éœ€æ±‚<br>âœ… é”™è¯¯å¤„ç†å®Œå–„ |

### 10.2 é‡Œç¨‹ç¢‘æ£€æŸ¥ç‚¹

#### **é‡Œç¨‹ç¢‘ Aï¼šæ•°æ®åº“åŸºç¡€å°±ç»ª (ç¬¬3å¤©ç»“æŸ)**
**éªŒæ”¶æ¡ä»¶**ï¼š
- âœ… SmartDosingDatabaseå¯æ­£å¸¸åˆ›å»ºå’Œè¿æ¥
- âœ… æ‰€æœ‰Entityå’ŒDAOç¼–è¯‘æ— é”™è¯¯
- âœ… åŸºç¡€CRUDæ“ä½œå•å…ƒæµ‹è¯•é€šè¿‡
- âœ… æ•°æ®åº“åˆå§‹åŒ–å’Œç¤ºä¾‹æ•°æ®æ’å…¥æˆåŠŸ

**å…³é”®ä»£ç éªŒè¯**ï¼š
```kotlin
// éªŒè¯æ•°æ®åº“è¿æ¥
val database = SmartDosingDatabase.getDatabase(context)
val recipeCount = database.recipeDao().getRecipeCount()
assert(recipeCount > 0) // ç¡®ä¿ç¤ºä¾‹æ•°æ®å·²æ’å…¥
```

#### **é‡Œç¨‹ç¢‘ Bï¼šRepositoryå±‚è¿ç§»å®Œæˆ (ç¬¬5å¤©ç»“æŸ)**
**éªŒæ”¶æ¡ä»¶**ï¼š
- âœ… RecipeRepositoryå®Œå…¨åˆ‡æ¢åˆ°æ•°æ®åº“å­˜å‚¨
- âœ… ç°æœ‰UIç•Œé¢æ•°æ®æ˜¾ç¤ºæ­£å¸¸ï¼ˆæ— å›å½’é—®é¢˜ï¼‰
- âœ… StateFlow/Flowæ•°æ®æµå“åº”æ­£å¸¸
- âœ… å¤æ‚æŸ¥è¯¢å’Œç­›é€‰åŠŸèƒ½æ­£ç¡®å·¥ä½œ

**å…³é”®åŠŸèƒ½éªŒè¯**ï¼š
```kotlin
// éªŒè¯Repositoryæ•°æ®æŒä¹…åŒ–
val repository = RecipeRepository(database.recipeDao())
val initialCount = repository.getAllRecipes().size

// é‡å¯åº”ç”¨æ¨¡æ‹Ÿ
database.close()
val newDatabase = SmartDosingDatabase.getDatabase(context)
val newRepository = RecipeRepository(newDatabase.recipeDao())
val afterRestartCount = newRepository.getAllRecipes().size

assert(initialCount == afterRestartCount) // æ•°æ®æŒä¹…åŒ–éªŒè¯
```

#### **é‡Œç¨‹ç¢‘ Cï¼šWebæœåŠ¡å®Œæ•´é›†æˆ (ç¬¬7å¤©ç»“æŸ)**
**éªŒæ”¶æ¡ä»¶**ï¼š
- âœ… Web APIæ‰€æœ‰ç°æœ‰æ¥å£æ­£å¸¸å·¥ä½œ
- âœ… CSV/Excelå¯¼å…¥åŠŸèƒ½æ•°æ®æŒä¹…åŒ–
- âœ… æ–°å¢å¤‡ä»½å’Œæ¢å¤åŠŸèƒ½å¯ç”¨
- âœ… åˆ†é¡µæŸ¥è¯¢æ€§èƒ½æ»¡è¶³è¦æ±‚(æŸ¥è¯¢å“åº”<100ms)

**APIæµ‹è¯•éªŒè¯**ï¼š
```bash
# éªŒè¯é…æ–¹æŸ¥è¯¢API
curl "http://localhost:8080/api/recipes?page=0&size=10"

# éªŒè¯å¯¼å…¥åŠŸèƒ½
curl -X POST -F "file=@test_recipes.csv" "http://localhost:8080/api/import/recipes"

# éªŒè¯å¤‡ä»½åŠŸèƒ½
curl -X POST "http://localhost:8080/api/backup/create"
```

#### **é‡Œç¨‹ç¢‘ Dï¼šç”Ÿäº§å°±ç»ª (ç¬¬10å¤©ç»“æŸ)**
**éªŒæ”¶æ¡ä»¶**ï¼š
- âœ… å®Œæ•´æµ‹è¯•å¥—ä»¶é€šè¿‡ï¼ˆå•å…ƒæµ‹è¯•+é›†æˆæµ‹è¯•ï¼‰
- âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•è¾¾æ ‡
- âœ… é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶éªŒè¯å®Œæˆ
- âœ… æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—å®Œå–„

### 10.3 é£é™©æ§åˆ¶ç‚¹

#### **é«˜é£é™©ç‚¹æ§åˆ¶**
| é£é™©é¡¹ | é£é™©çº§åˆ« | æ§åˆ¶æªæ–½ | åº”æ€¥é¢„æ¡ˆ |
|-------|---------|---------|---------|
| æ•°æ®è¿ç§»å¤±è´¥ | ğŸ”´ **é«˜** | â€¢ å……åˆ†çš„å•å…ƒæµ‹è¯•<br>â€¢ åˆ†é˜¶æ®µè¿ç§»<br>â€¢ æ•°æ®æ˜ å°„éªŒè¯ | â€¢ å›æ»šåˆ°å†…å­˜å­˜å‚¨<br>â€¢ æ•°æ®é‡æ–°å¯¼å…¥ |
| æ€§èƒ½ä¸è¾¾é¢„æœŸ | ğŸŸ¡ **ä¸­** | â€¢ åˆ†é¡µæŸ¥è¯¢è®¾è®¡<br>â€¢ ç´¢å¼•ä¼˜åŒ–<br>â€¢ æ‰¹é‡æ“ä½œäº‹åŠ¡ | â€¢ è°ƒæ•´æŸ¥è¯¢ç­–ç•¥<br>â€¢ ä¼˜åŒ–æ•°æ®åº“ç»“æ„ |
| APIå…¼å®¹æ€§é—®é¢˜ | ğŸŸ¡ **ä¸­** | â€¢ ä¿æŒæ¥å£ä¸å˜<br>â€¢ æ¸è¿›å¼é‡æ„<br>â€¢ APIæµ‹è¯•è¦†ç›– | â€¢ å¿«é€Ÿä¿®å¤<br>â€¢ æ¥å£ç‰ˆæœ¬æ§åˆ¶ |
| å¹¶å‘è®¿é—®å†²çª | ğŸŸ¢ **ä½** | â€¢ WALæ¨¡å¼å¯ç”¨<br>â€¢ äº‹åŠ¡éš”ç¦»<br>â€¢ é”™è¯¯å¤„ç† | â€¢ é‡è¯•æœºåˆ¶<br>â€¢ é”è¶…æ—¶å¤„ç† |

#### **æ¯æ—¥æ£€æŸ¥æ¸…å•**
- [ ] **Day 1-3**: Entityå’ŒDAOæ˜¯å¦ç¼–è¯‘é€šè¿‡ï¼Ÿå•å…ƒæµ‹è¯•æ˜¯å¦å…¨éƒ¨ç»¿è‰²ï¼Ÿ
- [ ] **Day 4-5**: Repositoryæ¥å£æ˜¯å¦ä¿æŒå…¼å®¹ï¼Ÿç°æœ‰UIæ˜¯å¦æ­£å¸¸ï¼Ÿ
- [ ] **Day 6-7**: Web APIæ˜¯å¦æ­£å¸¸å“åº”ï¼Ÿå¯¼å…¥åŠŸèƒ½æ˜¯å¦æ­£ç¡®æŒä¹…åŒ–ï¼Ÿ
- [ ] **Day 8-10**: å®Œæ•´æµç¨‹æ˜¯å¦ç«¯åˆ°ç«¯éªŒè¯ï¼Ÿæ€§èƒ½æ˜¯å¦è¾¾æ ‡ï¼Ÿ

### 10.4 æˆåŠŸæ ‡å‡†å®šä¹‰

#### **åŠŸèƒ½å®Œæ•´æ€§æ ‡å‡†**
- âœ… **æ•°æ®æŒä¹…åŒ–**ï¼šåº”ç”¨é‡å¯åæ‰€æœ‰æ•°æ®å®Œæ•´ä¿å­˜
- âœ… **åŠŸèƒ½ä¿æŒ**ï¼šç°æœ‰æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œæ— åŠŸèƒ½å›å½’
- âœ… **æ€§èƒ½è¾¾æ ‡**ï¼šé…æ–¹æŸ¥è¯¢<100msï¼Œå¯¼å…¥1000æ¡è®°å½•<10s
- âœ… **ç¨³å®šæ€§**ï¼šè¿ç»­è¿è¡Œ24å°æ—¶æ— å¼‚å¸¸ï¼Œé”™è¯¯æ¢å¤æœºåˆ¶æœ‰æ•ˆ

#### **æŠ€æœ¯è´¨é‡æ ‡å‡†**
- âœ… **ä»£ç è´¨é‡**ï¼šæ–°å¢ä»£ç éµå¾ªé¡¹ç›®è§„èŒƒï¼Œæ³¨é‡Šå®Œæ•´
- âœ… **æµ‹è¯•è¦†ç›–**ï¼šå•å…ƒæµ‹è¯•è¦†ç›–ç‡>80%ï¼Œå…³é”®è·¯å¾„100%è¦†ç›–
- âœ… **æ–‡æ¡£å®Œå–„**ï¼šAPIæ–‡æ¡£ã€æ•°æ®åº“è®¾è®¡æ–‡æ¡£ã€éƒ¨ç½²æŒ‡å—é½å…¨
- âœ… **å¯ç»´æŠ¤æ€§**ï¼šæ¨¡å—è§£è€¦æ¸…æ™°ï¼Œæ˜“äºåç»­åŠŸèƒ½æ‰©å±•

---

## ğŸ“‹ é¡¹ç›®äº¤ä»˜æ¸…å•

### æ ¸å¿ƒäº¤ä»˜ç‰©
- [ ] **å®Œæ•´çš„SQLiteæ•°æ®åº“é›†æˆ**ï¼ˆEntity + DAO + Databaseï¼‰
- [ ] **é‡æ„åçš„Repositoryå±‚**ï¼ˆä¿æŒæ¥å£å…¼å®¹ï¼Œå†…éƒ¨æ•°æ®åº“é©±åŠ¨ï¼‰
- [ ] **ä¼˜åŒ–çš„Web APIæœåŠ¡**ï¼ˆæ–°å¢å¤‡ä»½ã€åˆ†é¡µã€é”™è¯¯å¤„ç†ï¼‰
- [ ] **å®Œå–„çš„æµ‹è¯•å¥—ä»¶**ï¼ˆå•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• + æ€§èƒ½æµ‹è¯•ï¼‰
- [ ] **æŠ€æœ¯æ–‡æ¡£é›†åˆ**ï¼ˆæ•°æ®åº“è®¾è®¡ã€APIæ–‡æ¡£ã€éƒ¨ç½²æŒ‡å—ï¼‰

### æ‰©å±•ç‰¹æ€§
- [ ] **æ•°æ®å¤‡ä»½ä¸æ¢å¤ç³»ç»Ÿ**
- [ ] **å¯¼å…¥æ—¥å¿—å’Œå®¡è®¡åŠŸèƒ½**
- [ ] **åˆ†é¡µæŸ¥è¯¢å’Œæ€§èƒ½ä¼˜åŒ–**
- [ ] **é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ¢å¤æœºåˆ¶**

é€šè¿‡è¿™ä¸ªæ›´æ–°åçš„è®¡åˆ’ï¼ŒSmartDosingé¡¹ç›®å°†è·å¾—ç¨³å¥çš„æ•°æ®æŒä¹…åŒ–èƒ½åŠ›ï¼Œä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•ï¼ˆå¦‚å¤šç«¯åŒæ­¥ã€ç”¨æˆ·æƒé™ã€é«˜çº§ç»Ÿè®¡ç­‰ï¼‰å¥ å®šåšå®åŸºç¡€ï¼

## é™„å½•

### A. ä¾èµ–ç‰ˆæœ¬ä¿¡æ¯
```kotlin
// app/build.gradle.kts æ·»åŠ ä»¥ä¸‹ä¾èµ–
dependencies {
    // Room components
    implementation "androidx.room:room-runtime:2.6.1"
    implementation "androidx.room:room-ktx:2.6.1"
    kapt "androidx.room:room-compiler:2.6.1"

    // Testing
    testImplementation "androidx.room:room-testing:2.6.1"
    testImplementation "androidx.arch.core:core-testing:2.2.0"
    androidTestImplementation "androidx.test.ext:junit:1.1.5"
    androidTestImplementation "androidx.test.espresso:espresso-core:3.5.1"
}
```

### B. æ•°æ®åº“æ–‡ä»¶ä½ç½®
```
Androidè®¾å¤‡: /data/data/com.example.smartdosing/databases/smartdosing.db
å¤‡ä»½ä½ç½®: /sdcard/Android/data/com.example.smartdosing/files/backups/database/
```

### C. å…³é”®æ€§èƒ½æŒ‡æ ‡
- **é…æ–¹æŸ¥è¯¢**: < 100msï¼ˆ1000æ¡æ•°æ®ï¼‰
- **æ‰¹é‡å¯¼å…¥**: < 10sï¼ˆ1000æ¡é…æ–¹ï¼‰
- **æ•°æ®åº“å¤§å°**: < 50MBï¼ˆ10000æ¡é…æ–¹ï¼‰
- **å¤‡ä»½æ—¶é—´**: < 5sï¼ˆå®Œæ•´æ•°æ®åº“ï¼‰
