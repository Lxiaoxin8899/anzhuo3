# 📋 模板格式和导入解析检查报告

**检查时间**: 2024-11-24
**检查范围**: 模板定义、CSV/Excel生成、导入解析逻辑
**检查状态**: ✅ 全面检查完成

---

## 一、模板定义（TemplateRepository.kt）

### 1.1 标准模板字段定义

**模板ID**: `standard_recipe_template`
**模板名称**: 标准配方导入模板

#### 字段列表（按顺序）

| 序号 | Key | Label | 类型 | 必填 | 示例 | 说明 |
|------|-----|-------|------|------|------|------|
| 1 | recipe_name | 配方名称 | 文本 | ✅ 是 | 草莓烟油 | 配方唯一标识 |
| 2 | recipe_code | 配方编码 | 文本 | ❌ 否 | S000001 | 物料编号 |
| 3 | designer | 设计师 | 文本 | ❌ 否 | 张工 | 设计人员 |
| 4 | batch_no | 配方批次 | 文本 | ❌ 否 | 2025-Q1 | 批次版本 |
| 5 | recipe_category | 配方分类 | 文本 | ❌ 否 | 香精 | 分类统计 |
| 6 | recipe_description | 配方描述 | 文本 | ❌ 否 | 经典草莓烟油配方 | 配方说明 |
| 7 | material_line_1 | 材料1 | 特殊 | ✅ 是 | 草莓香精:50:g:1 | **格式：名称:重量:单位:序号** |
| 8 | material_line_2 | 材料2 | 特殊 | ❌ 否 | 草莓香精(溶剂):150:ml:2 | 格式同上 |
| 9 | material_line_3 | 材料3 | 特殊 | ❌ 否 | 柠檬酸:10:g:3 | 格式同上 |
| 10 | material_notes | 材料备注 | 文本 | ❌ 否 | 需低温保存 | 工艺说明 |

#### ✅ 检查结果

- **字段定义完整** ✅
- **字段顺序正确** ✅
- **必填字段标记正确** ✅
- **示例数据有效** ✅

---

## 二、CSV模板生成（generateCsvTemplate）

### 2.1 生成逻辑

**文件名格式**: `{模板名称}_模板.csv`
**编码**: UTF-8
**结构**:
```
第1行：列标题（从fields中的label字段）
第2行：示例数据（从fields中的example字段）
```

### 2.2 CSV转义处理

**代码位置**: TemplateRepository.kt 第441-446行

```kotlin
private fun escapeCsv(text: String): String {
    if (text.isEmpty()) return ""
    val needsQuotes = text.contains(",") || text.contains("\"") || text.contains("\n") || text.contains("\r")
    val escaped = text.replace("\"", "\"\"")
    return if (needsQuotes) "\"$escaped\"" else escaped
}
```

#### ✅ 检查结果

- **逗号转义** ✅ - 包含逗号的字段会被双引号包裹
- **引号转义** ✅ - 双引号会被转义为两个双引号
- **换行符处理** ✅ - 包含换行符的字段会被双引号包裹
- **UTF-8编码** ✅ - 使用Charsets.UTF_8

### 2.3 生成的CSV示例

```csv
配方名称,配方编码,设计师,配方批次,配方分类,配方描述,材料1名称:重量:单位:序号,材料2名称:重量:单位:序号,材料3名称:重量:单位:序号,材料/工艺备注
草莓烟油,S000001,张工,2025-Q1,香精,经典草莓烟油配方,草莓香精:50:g:1,草莓香精(溶剂):150:ml:2,柠檬酸:10:g:3,需低温保存
```

---

## 三、Excel模板生成（generateExcelTemplate）

### 3.1 生成逻辑

**文件名格式**: `{模板名称}_模板.xlsx`
**工作表结构**: 双工作表模式

#### 工作表1：配方信息（Summary Sheet）
- **列标题**: 所有**非材料字段**的label
- **示例行**: 对应的example数据
- **字段**: recipe_name, recipe_code, designer, batch_no, recipe_category, recipe_description, material_notes

#### 工作表2：材料明细（Detail Sheet）
- **固定列标题**: 配方编码 | 序号 | 材料名称 | 重量 | 单位 | 备注
- **示例行**: 从material_line_*字段解析示例数据

### 3.2 Excel文件结构

**OOXML格式** (Office Open XML):
```
[Content_Types].xml      - MIME类型定义
_rels/.rels             - 关系定义
xl/workbook.xml         - 工作簿
xl/_rels/workbook.xml.rels - 工作簿关系
xl/worksheets/sheet1.xml   - 配方信息表
xl/worksheets/sheet2.xml   - 材料明细表
xl/styles.xml           - 样式
docProps/core.xml       - 核心属性
docProps/app.xml        - 应用属性
```

### 3.3 XML转义处理

**代码位置**: TemplateRepository.kt 第448-456行

```kotlin
private fun escapeXml(text: String): String {
    if (text.isEmpty()) return ""
    return text
        .replace("&", "&amp;")
        .replace("<", "&lt;")
        .replace(">", "&gt;")
        .replace("\"", "&quot;")
        .replace("'", "&apos;")
}
```

#### ✅ 检查结果

- **XML实体转义** ✅ - 五个标准XML实体全部正确
- **双工作表生成** ✅ - 配方信息 + 材料明细
- **UTF-8编码** ✅ - 所有XML文件使用UTF-8

### 3.4 生成的Excel示例

**工作表1（配方信息）**:
```
| 配方名称   | 配方编码 | 设计师 | 配方批次 | 配方分类 | 配方描述         | 材料/工艺备注 |
|-----------|---------|--------|---------|---------|-----------------|--------------|
| 草莓烟油   | S000001 | 张工   | 2025-Q1 | 香精    | 经典草莓烟油配方 | 需低温保存    |
```

**工作表2（材料明细）**:
```
| 配方编码 | 序号 | 材料名称        | 重量 | 单位 | 备注 |
|---------|------|----------------|------|------|------|
| S000001 | 1    | 草莓香精        | 50   | g    |      |
| S000001 | 2    | 草莓香精(溶剂)  | 150  | ml   |      |
| S000001 | 3    | 柠檬酸          | 10   | g    |      |
```

---

## 四、CSV导入解析（importCsvFile）

### 4.1 解析流程

**代码位置**: DatabaseRecipeImportManager.kt 第54-151行

#### 解析步骤

1. **读取CSV** → UTF-8编码转换
2. **按行分割** → 过滤空行
3. **跳过表头** → 取第2行开始的数据
4. **逐行解析**:
   - 使用`parseCsvLine()`处理CSV格式
   - 按模板字段顺序映射到valueMap
   - 提取配方基本信息
   - 解析材料信息（parseInlineMaterials）
5. **批量持久化** → 使用数据库事务

### 4.2 CSV行解析（parseCsvLine）

**处理内容**:
- ✅ 引号包裹的字段
- ✅ 引号内的逗号
- ✅ 引号转义（""）
- ✅ 换行符

### 4.3 材料内联解析（parseInlineMaterials）

**代码位置**: 第367-392行

**格式**: `名称:重量:单位:序号`

```kotlin
val parts = value.split(":").map { it.trim() }
val name = parts.getOrNull(0).orEmpty()         // 材料名称
val weight = parts.getOrNull(1)?.toDoubleOrNull() // 重量（数字）
val unit = parts.getOrNull(2).orEmpty().ifBlank { "g" } // 单位，默认g
val sequence = parts.getOrNull(3)?.toIntOrNull() ?: (index + 1) // 序号，默认递增
```

#### ✅ 检查结果

- **格式验证** ✅ - 验证名称和重量必填
- **默认值处理** ✅ - 单位默认"g"，序号自动递增
- **错误提示** ✅ - 明确指出格式错误的行号和材料编号

### 4.4 字段映射

**代码位置**: 第109-147行

| 模板Key | 映射到RecipeImportRequest | 默认值 | 处理 |
|---------|--------------------------|--------|------|
| recipe_name | name | 无 | 必填，空白则报错 |
| recipe_code | code | "" | 可选 |
| recipe_category | category | "未分类" | 默认未分类 |
| recipe_subcategory | subCategory | "" | 可选 |
| customer | customer | "" | 可选 |
| batch_no | batchNo | "" | 可选 |
| version | version | "1.0" | 默认1.0 |
| recipe_description + material_notes | description | "" | 合并两个字段 |
| material_line_* | materials | [] | 解析为MaterialImport列表 |
| creator | creator | "IMPORT" | 默认IMPORT |
| reviewer | reviewer | "" | 可选 |

#### ✅ 检查结果

- **必填字段验证** ✅ - recipe_name必须存在
- **默认值合理** ✅ - category默认"未分类"，version默认"1.0"
- **材料必须存在** ✅ - 至少要有一个有效材料

---

## 五、Excel导入解析（importExcel）

### 5.1 解析流程

**代码位置**: DatabaseRecipeImportManager.kt 第156-258行

#### 解析步骤

1. **解压ZIP** → 提取XML文件
2. **验证工作表** → 确认sheet1.xml和sheet2.xml存在
3. **解析配方信息表**:
   - 提取summary字段
   - 按字段顺序映射
4. **解析材料明细表**:
   - 按固定列顺序：配方编码|序号|材料名称|重量|单位|备注
   - 按配方编码分组
5. **关联数据**:
   - 通过normalizeKey匹配配方编码
   - 将材料明细关联到对应配方
6. **批量持久化** → 使用数据库事务

### 5.2 工作表解析（parseSheetXml）

**代码位置**: 第408-419行

**正则表达式**:
```kotlin
val rowRegex = Regex("<row[^>]*>(.*?)</row>", RegexOption.DOT_MATCHES_ALL)
val cellRegex = Regex("<t[^>]*>(.*?)</t>", RegexOption.DOT_MATCHES_ALL)
```

#### ✅ 检查结果

- **XML解析** ✅ - 正确提取row和cell
- **XML反转义** ✅ - unescapeXml处理实体
- **空行过滤** ✅ - 过滤全空白行

### 5.3 材料明细解析（parseDetailRows）

**代码位置**: 第332-365行

**固定列顺序**:
```
列0: 配方编码（必填）
列1: 序号（可选，默认自动递增）
列2: 材料名称（必填）
列3: 重量（必填，数字）
列4: 单位（可选，默认"g"）
列5: 备注（可选）
```

#### ✅ 检查结果

- **配方编码验证** ✅ - 空白则报错
- **名称和重量验证** ✅ - 必填验证
- **按配方编码分组** ✅ - 使用normalizeKey标准化
- **序号自动处理** ✅ - 无效序号则自动递增

### 5.4 配方编码标准化（normalizeKey）

**目的**: 确保配方信息和材料明细能正确关联

**逻辑**:
```kotlin
normalizeKey(code, fallbackName)
```

- 优先使用code（如果非空）
- 否则使用fallbackName
- 转为小写并去除空格

#### ✅ 检查结果

- **关联逻辑正确** ✅ - 配方编码为空时使用配方名称
- **大小写不敏感** ✅ - 转小写匹配

---

## 六、事务和错误处理

### 6.1 数据库事务

**代码位置**: 第263-298行

```kotlin
database.runInTransaction {
    requests.forEachIndexed { index, request ->
        try {
            kotlinx.coroutines.runBlocking {
                databaseRepository.addRecipe(request)
            }
            successCount++
        } catch (e: Exception) {
            errors += "第${index + 1}条配方导入失败：${e.message}"
        }
    }
}
```

#### ✅ 检查结果

- **事务保护** ✅ - 使用runInTransaction确保原子性
- **单条失败不影响其他** ✅ - try-catch包裹单条插入
- **错误收集** ✅ - 记录每条失败的详细信息

### 6.2 导入日志记录

**代码位置**: 第303-326行

**记录内容**:
- 文件名、文件大小、文件类型
- 导入耗时
- 成功数、失败数
- 错误详情

#### ✅ 检查结果

- **完整的日志** ✅ - 所有关键信息都记录
- **日志失败不影响导入** ✅ - 日志记录异常被捕获

---

## 七、潜在问题和建议

### ⚠️ 发现的问题

#### 1. CSV材料格式不够灵活 ⚠️

**问题**: 材料格式固定为`名称:重量:单位:序号`，如果用户不按此格式填写会报错。

**影响**: 中等
**建议**:
- 在模板中加粗标注格式要求
- 或者提供更宽容的解析（如允许省略序号）

#### 2. Excel工作表名称硬编码 ⚠️

**代码位置**: WebServerManager.kt 第165-166行
```kotlin
val summaryXml = entries["xl/worksheets/sheet1.xml"]
val detailXml = entries["xl/worksheets/sheet2.xml"]
```

**问题**: 如果用户修改工作表顺序，会导入失败。

**影响**: 低
**建议**:
- 按工作表名称查找（"配方信息"、"材料明细"）
- 或在模板中明确说明不要修改工作表顺序

#### 3. 缺少列标题验证 ⚠️

**问题**: 没有验证CSV/Excel的列标题是否与模板匹配。

**影响**: 低
**建议**:
- 添加列标题验证
- 不匹配时给出友好提示

### ✅ 优点

1. **UTF-8编码完整** ✅ - CSV和Excel全程UTF-8，中文无问题
2. **事务保护** ✅ - 批量导入使用数据库事务
3. **错误信息详细** ✅ - 明确指出问题行号
4. **默认值合理** ✅ - category、version、unit等有合理默认值
5. **灵活的字段映射** ✅ - 支持可选字段
6. **双工作表Excel** ✅ - 配方信息和材料明细分离，结构清晰

---

## 八、测试建议

### 测试用例

#### CSV导入测试

1. **标准格式测试** ✅
   - 使用模板下载的CSV
   - 填写完整数据
   - 预期：全部导入成功

2. **中文测试** ✅
   - 配方名称、材料名称使用中文
   - 预期：显示正常

3. **特殊字符测试**
   - 名称包含逗号、引号
   - 预期：正确转义

4. **材料格式错误测试**
   - 材料格式错误（如缺少冒号）
   - 预期：明确报错

5. **必填字段缺失测试**
   - recipe_name为空
   - 预期：报错"缺少配方名称"

#### Excel导入测试

1. **双工作表测试** ✅
   - 配方信息表和材料明细表都有数据
   - 预期：正确关联并导入

2. **配方编码关联测试**
   - 材料明细表的配方编码与配方信息表匹配
   - 预期：材料正确关联到配方

3. **配方编码不匹配测试**
   - 材料明细表有无效的配方编码
   - 预期：报错"未找到对应配方"

4. **工作表缺失测试**
   - 只有一个工作表
   - 预期：报错"缺少必要的工作表"

---

## 九、总结

### ✅ 总体评价：**优秀**

| 检查项 | 状态 | 评分 |
|--------|------|------|
| 模板字段定义 | ✅ 完整 | 10/10 |
| CSV生成逻辑 | ✅ 正确 | 10/10 |
| Excel生成逻辑 | ✅ 正确 | 10/10 |
| CSV解析逻辑 | ✅ 正确 | 9/10 |
| Excel解析逻辑 | ✅ 正确 | 9/10 |
| UTF-8编码处理 | ✅ 完美 | 10/10 |
| 错误处理 | ✅ 完善 | 9/10 |
| 事务管理 | ✅ 正确 | 10/10 |

**综合评分**: **9.6/10** 🌟🌟🌟🌟🌟

### 核心优势

1. ✅ **完整的UTF-8支持** - 中文显示无问题
2. ✅ **双格式支持** - CSV简单快捷，Excel结构清晰
3. ✅ **事务保护** - 数据一致性有保障
4. ✅ **详细的错误提示** - 用户友好
5. ✅ **灵活的字段设计** - 必填和可选分明

### 改进建议

1. ⚠️ 添加列标题验证
2. ⚠️ 更灵活的材料格式解析
3. ⚠️ 按工作表名称查找而非位置

---

## 十、结论

**模板格式和导入解析系统整体设计合理，实现正确，可以投入使用。** ✅

**建议**：
1. 先进行标准测试用例验证
2. 准备测试数据（包含边界情况）
3. 记录导入日志，观察实际使用情况
4. 根据用户反馈优化错误提示

**下一步**:
- 安装最新APK
- 下载模板测试
- 导入测试数据验证

---

**检查完成时间**: 2024-11-24
**检查人员**: AI Assistant
**报告版本**: v1.0
